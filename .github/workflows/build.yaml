name: 生成中国IP段IPSET转储文件

on:
  workflow_dispatch:
  schedule:
    - cron:  '0 4 */3 * *'

jobs:
  build:
    name: 任务
    runs-on: ubuntu-latest
    steps:
    - name: 安装必要工具
      run: |
        sudo apt-get update
        sudo apt-get install -y ipset

    - name: 步骤一下载中国IP段
      run: |
        curl -LR -o CN-ip-cidr.txt "https://github.com/Hackl0us/GeoIP2-CN/raw/release/CN-ip-cidr.txt"

    - name: 步骤二创建IPSET
      run: |
        sudo ipset create CHINA:CIDR hash:net
        sudo ipset add CHINA:CIDR 192.168.1.0/24
        sudo ipset list CHINA:CIDR

    - name: 步骤三导入中国IP段
      run: |
        bash <<EOF
        #!/bin/bash
        for item in $(cat CN-ip-cidr.txt); do
            echo $item
            exit 0
        done
        EOF

    - name: 步骤四导出中国IP段IPSET转储文件
      run: |
        bash <<EOF
        #!/bin/bash
        sudo ipset save CHINA:CIDR > china_cidr_ipset.txt
        ls -a
        EOF